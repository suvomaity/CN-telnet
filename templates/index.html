<!DOCTYPE html>
<html lang="en">
<head>
    <title>CN-Telnet Web Client</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery, Chart.js, Socket.IO -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { background-color: aliceblue; font-family: 'Courier New', monospace; }
        .telnet-card { border-left: 4px solid #28a745; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); }
        #output { background: #000; color: #00ff00; height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; white-space: pre-wrap; }
        .btn-telnet { background-color: #28a745; border-color: #28a745; }
        .btn-telnet:hover { background-color: #218838; }
        #portChart { max-height: 200px; }
        .progress { height: 20px; }
        .alert-flash { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h1 class="text-center mb-4 text-success">CN-Telnet Web</h1>
                {% if current_user.is_authenticated %}
                    <div class="alert alert-info text-center">
                        Welcome, {{ current_user.id }}! <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
                    </div>
                {% endif %}

                <div class="row g-4">
                    <!-- Telnet Controls (Left) -->
                    <div class="col-md-6">
                        <div class="card telnet-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Telnet Controls</h5>
                            </div>
                            <div class="card-body">
                                <!-- Connect -->
                                <div class="mb-3">
                                    <label class="form-label">Connect to Server</label>
                                    <div class="input-group">
                                        <input id="host" class="form-control" placeholder="Host (e.g., 127.0.0.1)" />
                                        <input id="port" class="form-control" type="number" placeholder="Port (e.g., 8080)" />
                                        <button class="btn btn-telnet" onclick="connect()">Connect</button>
                                        <button class="btn btn-outline-secondary" onclick="disconnect()">Disconnect</button>
                                    </div>
                                </div>

                                <!-- Send Message -->
                                <div class="mb-3">
                                    <label class="form-label">Send Message</label>
                                    <textarea id="message" class="form-control" rows="2" placeholder="Enter message..."></textarea>
                                    <button class="btn btn-telnet mt-2" onclick="sendMessage()">Send Message</button>
                                </div>

                                <!-- Upload -->
                                <div class="mb-3">
                                    <label class="form-label">Upload File</label>
                                    <input id="file" class="form-control" type="file" />
                                    <button class="btn btn-telnet mt-2" onclick="upload()">Upload File</button>
                                </div>

                                <!-- NEW: Exec Command -->
                                <div class="mb-3">
                                    <label class="form-label">Exec Command (Remote)</label>
                                    <input id="cmd" class="form-control" placeholder="e.g., ls -la" />
                                    <button class="btn btn-telnet mt-2" onclick="execCmd()">Exec</button>
                                </div>

                                <!-- NEW: Download File -->
                                <div class="mb-3">
                                    <label class="form-label">Download File</label>
                                    <input id="dl_file" class="form-control" placeholder="filename.txt" />
                                    <button class="btn btn-telnet mt-2" onclick="downloadFile()">Download</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scan & Output (Right) -->
                    <div class="col-md-6">
                        <div class="card telnet-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Port Scanner & Output</h5>
                            </div>
                            <div class="card-body">
                                <!-- Port Scan -->
                                <div class="mb-3">
                                    <label class="form-label">Scan Ports</label>
                                    <div class="input-group mb-2">
                                        <input id="scan_host" class="form-control" placeholder="Host (e.g., 127.0.0.1)" />
                                        <span class="input-group-text">From</span>
                                        <input id="start_port" class="form-control w-auto" type="number" value="1" />
                                        <span class="input-group-text">to</span>
                                        <input id="end_port" class="form-control w-auto" type="number" value="100" />
                                    </div>
                                    <button class="btn btn-telnet w-100" onclick="scanPorts()">Scan Ports</button>
                                    <div class="progress mt-2" id="scanProgress" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%">0% (0 open)</div>
                                    </div>
                                </div>
                                <canvas id="portChart" class="w-100"></canvas>

                                <!-- Output Log -->
                                <div class="mt-3">
                                    <label class="form-label">Output Log</label>
                                    <div id="output" class="border rounded p-2 bg-dark text-light"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat (Full Width Below) -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card telnet-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Multi-User Chat</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <input id="username" class="form-control" placeholder="Your name" />
                                    </div>
                                    <div class="col-md-4">
                                        <input id="room" class="form-control" value="lab_group" placeholder="Room" />
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-telnet w-100" onclick="joinRoom()">Join Chat</button>
                                    </div>
                                </div>
                                <div id="messages" class="border rounded p-3 bg-light mb-3" style="height: 200px; overflow-y: auto;"></div>
                                <div class="input-group">
                                    <input id="chat_msg" class="form-control" placeholder="Type message..." />
                                    <button class="btn btn-telnet" onclick="sendChat()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-warning alert-flash">{{ messages[0] }}</div>
            {% endif %}
        {% endwith %}
    </div>

    <script>
        const socket = io();
        let chart;
        let scanInterval;

        function appendOutput(msg, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const pre = $('<pre class="mb-0">').text(JSON.stringify(msg, null, 2)).css('color', isError ? 'red' : '#00ff00');
            $('#output').append(`<p class="mb-1"><small class="text-muted">[${timestamp}] ${isError ? 'ERROR: ' : ''}</small></p>`).append(pre).append('<hr class="my-1">');
            console.log(`[${timestamp}] ${msg}`);
            $('#output').scrollTop($('#output')[0].scrollHeight);
        }

        // Existing connect, disconnect, sendMessage, upload, joinRoom, sendChat unchanged...

        function connect() {
            const host = $('#host').val();
            const port = $('#port').val();
            console.log("Connect clicked! Host:", host, "Port:", port);
            if (!host || !port) {
                appendOutput("Error: Enter host and port", true);
                return;
            }
            $.ajax({
                url: '/connect',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({host: host, port: port})
            })
            .done(function(data) {
                console.log("Connect Success:", data);
                appendOutput(data);
                if (data.status === 'Connected') {
                    socket.emit('join_chat', {username: 'TelnetUser', room: 'telnet_chat'});
                }
            })
            .fail(function(xhr, status, error) {
                console.log("Connect Fail:", status, error, xhr.responseText);
                let errData = {status: "Error", error: error + " (Status: " + status + ")"};
                try {
                    errData = JSON.parse(xhr.responseText);
                } catch (e) {}
                appendOutput(errData, true);
            });
        }

        function disconnect() {
            $.post('/disconnect')
                .done(function(data) {
                    appendOutput(data);
                })
                .fail(function(xhr, status, error) {
                    appendOutput({status: "Error", error: error}, true);
                });
        }

        function sendMessage() {
            const msg = $('#message').val();
            console.log("Send clicked! Msg:", msg);
            if (!msg) {
                appendOutput("Error: Enter a message", true);
                return;
            }
            $.ajax({
                url: '/send',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({message: msg})
            })
            .done(function(data) {
                console.log("Send Success:", data);
                appendOutput(data);
                socket.emit('message', {msg: msg, username: 'TelnetUser', room: 'telnet_chat'});
                $('#message').val('');
            })
            .fail(function(xhr, status, error) {
                console.log("Send Fail:", status, error, xhr.responseText);
                let errData = {status: "Error", error: error};
                try {
                    errData = JSON.parse(xhr.responseText);
                } catch (e) {}
                appendOutput(errData, true);
            });
        }

        function upload() {
            const fileInput = $('#file')[0].files[0];
            console.log("Upload clicked! File:", fileInput ? fileInput.name : "None");
            if (!fileInput) {
                appendOutput("Error: Select a file", true);
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput);
            $.ajax({url: '/upload', type: 'POST', data: formData, processData: false, contentType: false})
                .done(function(data) {
                    console.log("Upload Success:", data);
                    appendOutput(data);
                    $('#file').val('');
                })
                .fail(function(xhr, status, error) {
                    console.log("Upload Fail:", status, error, xhr.responseText);
                    let errData = {status: "Error", error: error};
                    try {
                        errData = JSON.parse(xhr.responseText);
                    } catch (e) {}
                    appendOutput(errData, true);
                });
        }

        // NEW: Exec Cmd
        function execCmd() {
            const cmd = $('#cmd').val();
            if (!cmd) {
                appendOutput("Error: Enter a command", true);
                return;
            }
            $.ajax({
                url: '/exec',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({command: cmd})
            })
            .done(function(data) {
                console.log("Exec Success:", data);
                appendOutput(data);
                $('#cmd').val('');
            })
            .fail(function(xhr, status, error) {
                let errData = {status: "Error", error: error};
                try {
                    errData = JSON.parse(xhr.responseText);
                } catch (e) {}
                appendOutput(errData, true);
            });
        }

        // NEW: Download File
        function downloadFile() {
            const filename = $('#dl_file').val();
            if (!filename) {
                appendOutput("Error: Enter filename", true);
                return;
            }
            $.ajax({
                url: '/download',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({filename: filename}),
                xhrFields: { responseType: 'blob' }  // For binary
            })
            .done(function(data, status, xhr) {
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                appendOutput({status: "Downloaded", file: filename});
                $('#dl_file').val('');
            })
            .fail(function(xhr, status, error) {
                let errData = {status: "Error", error: error};
                try {
                    errData = JSON.parse(xhr.responseText);
                } catch (e) {}
                appendOutput(errData, true);
            });
        }

        function scanPorts() {
            const host = $('#scan_host').val();
            const start = $('#start_port').val();
            const end = $('#end_port').val();
            console.log("Scan clicked! Host:", host, "Ports:", start + "-" + end);
            if (!host) {
                appendOutput("Error: Enter host", true);
                return;
            }
            // Show progress
            const progressBar = $('#scanProgress .progress-bar');
            $('#scanProgress').show();
            progressBar.text('0% (0 open)').css('width', '0%');

            $.ajax({
                url: '/scan',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({host: host, start: start, end: end})
            })
            .done(function(data) {
                console.log("Scan Success:", data);
                appendOutput({summary: `${data.open_count}/${data.total_ports} open ports`});
                const labels = data.open_ports.map(p => 'Port ' + p);
                const ctx = document.getElementById('portChart').getContext('2d');
                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Open Ports', data: data.open_ports.map(() => 1), backgroundColor: '#28a745' }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, max: 1 } } }
                });
            })
            .fail(function(xhr, status, error) {
                $('#scanProgress').hide();
                console.log("Scan Fail:", status, error, xhr.responseText);
                let errData = {status: "Error", error: error};
                try {
                    errData = JSON.parse(xhr.responseText);
                } catch (e) {}
                appendOutput(errData, true);
            });

            // UPGRADE: Listen for real-time updates
            socket.on('scan_update', function(data) {
                const progress = data.progress;
                const opens = data.open_count;
                progressBar.text(`${Math.round(progress)}% (${opens} open)`).css('width', progress + '%');
            });

            socket.once('scan_complete', function(data) {
                progressBar.text('100% Complete');
                setTimeout(() => $('#scanProgress').hide(), 1000);
            });
        }

        function joinRoom() {
            const username = $('#username').val() || 'Anonymous';
            const room = $('#room').val() || 'general';
            socket.emit('join_chat', {username, room});
            appendOutput(`Joined room: ${room} as ${username}`);
        }

        function sendChat() {
            const msg = $('#chat_msg').val();
            const username = $('#username').val() || 'Anonymous';
            const room = $('#room').val() || 'general';
            if (msg) {
                socket.emit('message', {msg, username, room});
                $('#chat_msg').val('');
            }
        }

        socket.on('message', function(data) {
            $('#messages').append(`<div class="mb-1"><strong>${data.username}:</strong> ${data.msg}</div>`).scrollTop($('#messages')[0].scrollHeight);
        });

        socket.on('status', function(data) {
            $('#messages').append(`<div class="text-muted small mb-1">${data.msg}</div>`).scrollTop($('#messages')[0].scrollHeight);
        });
    </script>
</body>
</html>